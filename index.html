<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>任务确认</title>
<style>
  :root { --fg:#111; --muted:#666; --ok:#2e7d32; --err:#d32f2f; --bd:#e9e9e9; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:var(--fg);margin:0;padding:28px;}
  .card{max-width:560px;margin:0 auto;background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03);padding:18px 20px;}
  h2{margin:4px 0 10px 0}
  p{margin:.4rem 0;color:var(--muted)}
  textarea{width:100%;min-height:96px;resize:vertical;border:1px solid var(--bd);border-radius:8px;padding:10px;font:inherit}
  button{margin-top:10px;border:1px solid var(--bd);background:#ffcf58;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600}
  button:disabled{opacity:.6;cursor:not-allowed}
  .tip{margin-top:12px;line-height:1.6}
  .tip.ok{color:var(--ok)}
  .tip.err{color:var(--err)}
  code{background:#f4f4f4;padding:0 4px;border-radius:4px}
  a.link{display:inline-block;margin-top:6px;text-decoration:none}
</style>

<body>
  <div class="card">
    <h2>请确认完成</h2>
    <p>点击下方按钮即可回传完成状态；可填写备注。</p>

    <textarea id="remark" placeholder="例如：已完成，见截图…"></textarea><br/>
    <button id="done">完成并提交</button>
    <div id="tip" class="tip"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const sid     = qs.get('sid') || '';
    const unionid = qs.get('unionid') || '';
    const dueTime = qs.get('dueTime') || '';

    const tip = document.getElementById('tip');
    const btn = document.getElementById('done');
    const remarkEl = document.getElementById('remark');

    const buildViewUrl = (dataOrRemark) => {
      const rmk = typeof dataOrRemark === 'string'
        ? dataOrRemark
        : (dataOrRemark?.remark || '');
      const u = typeof dataOrRemark === 'object' && dataOrRemark?.unionid ? dataOrRemark.unionid : unionid;
      const d = typeof dataOrRemark === 'object' && dataOrRemark?.dueTime ? dataOrRemark.dueTime : dueTime;
      const p = new URLSearchParams({ sid, unionid: u || '', dueTime: d || '', remark: rmk || '' });
      return `${location.origin}/view.html?${p.toString()}`;
    };

    // ===== 进入页面先查一次状态：已提交则直接跳到只读页 =====
    (async () => {
      if (!sid) return;
      try {
        const r = await fetch(`/.netlify/functions/feedback?op=status&sid=${encodeURIComponent(sid)}`);
        const d = await r.json();
        if (d.done && d.record) {
          location.replace(buildViewUrl(d.record)); // 只读
        }
      } catch {}
    })();

    btn.addEventListener('click', async () => {
      const remark = remarkEl.value || '';
      const viewUrl = buildViewUrl(remark);

      btn.disabled = true;
      tip.className = 'tip';
      tip.textContent = '正在提交…';

      try {
        const r = await fetch('/.netlify/functions/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sid, unionid, dueTime, remark, detailUrl: viewUrl })
        });
        const data = await r.json();

        // 已提交过（409）→ 直接跳只读
        if (r.status === 409 || data.error === 'already_submitted') {
          location.replace(buildViewUrl(data.record || ''));
          return;
        }

        if (!r.ok || !data.ok) throw new Error(data.error || '提交失败');

        tip.className = 'tip ok';
        tip.innerHTML = `
          已记录完成。<br>
          SID：<code>${data.sid}</code><br>
          备注：${data.remark || '—'}<br>
          时间：${data.timeCN}<br>
          <a class="link" href="${viewUrl}" target="_blank">👉 查看详情</a>
        `;
        // 成功后不再允许再次提交
        btn.disabled = true;
      } catch (e) {
        tip.className = 'tip err';
        tip.textContent = e.message || String(e);
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
