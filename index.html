<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä»»åŠ¡ç¡®è®¤</title>
<style>
  :root { --fg:#111; --muted:#666; --ok:#2e7d32; --err:#d32f2f; --bd:#e9e9e9; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:var(--fg);margin:0;padding:28px;}
  .card{max-width:560px;margin:0 auto;background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03);padding:18px 20px;}
  h2{margin:4px 0 10px 0}
  p{margin:.4rem 0;color:var(--muted)}
  textarea{width:100%;min-height:96px;resize:vertical;border:1px solid var(--bd);border-radius:8px;padding:10px;font:inherit}
  button{margin-top:10px;border:1px solid var(--bd);background:#ffcf58;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600}
  button:disabled{opacity:.6;cursor:not-allowed}
  .tip{margin-top:12px;line-height:1.6}
  .tip.ok{color:var(--ok)}
  .tip.err{color:var(--err)}
  code{background:#f4f4f4;padding:0 4px;border-radius:4px}
  a.link{display:inline-block;margin-top:6px;text-decoration:none}
</style>

<body>
  <div class="card">
    <h2>è¯·ç¡®è®¤å®Œæˆ</h2>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å³å¯å›ä¼ å®ŒæˆçŠ¶æ€ï¼›å¯å¡«å†™å¤‡æ³¨ã€‚</p>

    <textarea id="remark" placeholder="ä¾‹å¦‚ï¼šå·²å®Œæˆï¼Œè§æˆªå›¾â€¦"></textarea><br/>
    <button id="done">å®Œæˆå¹¶æäº¤</button>
    <div id="tip" class="tip"></div>
  </div>

  <script>
    // ===== åŸºç¡€å‚æ•°ä¸å·¥å…· =====
    const qs = new URLSearchParams(location.search);
    const sid     = qs.get('sid') || '';
    const unionid = qs.get('unionid') || '';
    const dueTime = qs.get('dueTime') || '';
    const FN_URL  = '/.netlify/functions/feedback';

    const tip = document.getElementById('tip');
    const btn = document.getElementById('done');
    const remarkEl = document.getElementById('remark');

    const buildViewUrl = (dataOrRemark) => {
      const remark = (typeof dataOrRemark === 'string')
        ? dataOrRemark
        : (dataOrRemark && dataOrRemark.remark) || '';
      const u = (typeof dataOrRemark === 'object' && dataOrRemark.unionid) ? dataOrRemark.unionid : unionid;
      const d = (typeof dataOrRemark === 'object' && dataOrRemark.dueTime) ? dataOrRemark.dueTime : dueTime;
      const p = new URLSearchParams({ sid, unionid: u || '', dueTime: d || '', remark: remark || '' });
      return `${location.origin}/view.html?${p.toString()}`;
    };

    const jumpToView = (recordOrRemark='') => {
      const href = (recordOrRemark && recordOrRemark.detailUrl)
        ? recordOrRemark.detailUrl
        : buildViewUrl(recordOrRemark);
      location.replace(href);
    };

    const showErr = (msg) => { tip.className='tip err'; tip.textContent = msg; };
    const showOk  = (html) => { tip.className='tip ok';  tip.innerHTML  = html; };

    // ===== è¿›å…¥é¡µé¢ï¼šå…ˆæŸ¥çŠ¶æ€ï¼ˆå·²æäº¤åˆ™ç›´æ¥åªè¯»ï¼‰=====
    (async () => {
      if (!sid) { showErr('ç¼ºå°‘ sidï¼Œæ— æ³•æäº¤'); btn.disabled = true; return; }
      try {
        const r = await fetch(`${FN_URL}?op=status&sid=${encodeURIComponent(sid)}`);
        const d = await r.json();
        if (d.done && d.record) jumpToView(d.record); // å·²æäº¤ï¼šè·³åªè¯»
      } catch { /* å¿½ç•¥ï¼Œäº¤ç”±ç”¨æˆ·ç‚¹å‡»æ—¶å†å¤„ç† */ }
    })();

    // ===== ç‚¹å‡»æäº¤ =====
    btn.addEventListener('click', async () => {
      const remark = remarkEl.value || '';
      const detailUrl = buildViewUrl(remark);

      btn.disabled = true;
      tip.className = 'tip';
      tip.textContent = 'æ­£åœ¨æäº¤â€¦';

      try {
        const r = await fetch(FN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sid, unionid, dueTime, remark, detailUrl })
        });
        const data = await r.json().catch(() => ({}));

        // å·²è¢«ä»–äºº/è‡ªå·±å…ˆæäº¤ï¼šåç«¯è¿”å› 409
        if (r.status === 409 || data.error === 'already_submitted') {
          jumpToView(data.record || '');
          return;
        }

        if (!r.ok || !data.ok) throw new Error(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');

        // æˆåŠŸï¼šç¦ç”¨æŒ‰é’®å¹¶æä¾›æŸ¥çœ‹è¯¦æƒ…
        btn.disabled = true;
        const viewUrl = data.detailUrl || detailUrl;
        showOk(`å·²è®°å½•å®Œæˆã€‚<br>
          SIDï¼š<code>${data.sid}</code><br>
          å¤‡æ³¨ï¼š${data.remark || 'â€”'}<br>
          æ—¶é—´ï¼š${data.timeCN}<br>
          <a class="link" href="${viewUrl}" target="_blank">ğŸ‘‰ æŸ¥çœ‹è¯¦æƒ…</a>
        `);
      } catch (e) {
        showErr(e.message || String(e));
        btn.disabled = false; // å¤±è´¥å¯é‡è¯•
      }
    });
  </script>
</body>
</html>
