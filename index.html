<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>任务确认</title>
<style>
  :root { --fg:#111; --muted:#666; --ok:#2e7d32; --err:#d32f2f; --bd:#e9e9e9; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:var(--fg);margin:0;padding:28px;}
  .card{max-width:560px;margin:0 auto;background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03);padding:18px 20px;}
  h2{margin:4px 0 10px 0}
  p{margin:.4rem 0;color:var(--muted)}
  textarea{width:100%;min-height:96px;resize:vertical;border:1px solid var(--bd);border-radius:8px;padding:10px;font:inherit}
  button{margin-top:10px;border:1px solid var(--bd);background:#ffcf58;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600}
  button:disabled{opacity:.6;cursor:not-allowed}
  .tip{margin-top:12px;line-height:1.6}
  .tip.ok{color:var(--ok)}
  .tip.err{color:var(--err)}
  code{background:#f4f4f4;padding:0 4px;border-radius:4px}
  a.link{display:inline-block;margin-top:6px;text-decoration:none}
</style>

<body>
  <div class="card">
    <h2>请确认完成</h2>
    <p>点击下方按钮即可回传完成状态；可填写备注。</p>

    <textarea id="remark" placeholder="例如：已完成，见截图…"></textarea><br/>
    <button id="done">完成并提交</button>
    <div id="tip" class="tip"></div>
  </div>

  <script>
    // ===== 基础参数与工具 =====
    const qs = new URLSearchParams(location.search);
    const sid     = qs.get('sid') || '';
    const unionid = qs.get('unionid') || '';
    const dueTime = qs.get('dueTime') || '';
    const FN_URL  = '/.netlify/functions/feedback';

    const tip = document.getElementById('tip');
    const btn = document.getElementById('done');
    const remarkEl = document.getElementById('remark');

    const buildViewUrl = (dataOrRemark) => {
      const remark = (typeof dataOrRemark === 'string')
        ? dataOrRemark
        : (dataOrRemark && dataOrRemark.remark) || '';
      const u = (typeof dataOrRemark === 'object' && dataOrRemark.unionid) ? dataOrRemark.unionid : unionid;
      const d = (typeof dataOrRemark === 'object' && dataOrRemark.dueTime) ? dataOrRemark.dueTime : dueTime;
      const p = new URLSearchParams({ sid, unionid: u || '', dueTime: d || '', remark: remark || '' });
      return `${location.origin}/view.html?${p.toString()}`;
    };

    const jumpToView = (recordOrRemark='') => {
      const href = (recordOrRemark && recordOrRemark.detailUrl)
        ? recordOrRemark.detailUrl
        : buildViewUrl(recordOrRemark);
      location.replace(href);
    };

    const showErr = (msg) => { tip.className='tip err'; tip.textContent = msg; };
    const showOk  = (html) => { tip.className='tip ok';  tip.innerHTML  = html; };

    // ===== 进入页面：先查状态（已提交则直接只读）=====
    (async () => {
      if (!sid) { showErr('缺少 sid，无法提交'); btn.disabled = true; return; }
      try {
        const r = await fetch(`${FN_URL}?op=status&sid=${encodeURIComponent(sid)}`);
        const d = await r.json();
        if (d.done && d.record) jumpToView(d.record); // 已提交：跳只读
      } catch { /* 忽略，交由用户点击时再处理 */ }
    })();

    // ===== 点击提交 =====
    btn.addEventListener('click', async () => {
      const remark = remarkEl.value || '';
      const detailUrl = buildViewUrl(remark);

      btn.disabled = true;
      tip.className = 'tip';
      tip.textContent = '正在提交…';

      try {
        const r = await fetch(FN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sid, unionid, dueTime, remark, detailUrl })
        });
        const data = await r.json().catch(() => ({}));

        // 已被他人/自己先提交：后端返回 409
        if (r.status === 409 || data.error === 'already_submitted') {
          jumpToView(data.record || '');
          return;
        }

        if (!r.ok || !data.ok) throw new Error(data.error || '提交失败，请稍后重试');

        // 成功：禁用按钮并提供查看详情
        btn.disabled = true;
        const viewUrl = data.detailUrl || detailUrl;
        showOk(`已记录完成。<br>
          SID：<code>${data.sid}</code><br>
          备注：${data.remark || '—'}<br>
          时间：${data.timeCN}<br>
          <a class="link" href="${viewUrl}" target="_blank">👉 查看详情</a>
        `);
      } catch (e) {
        showErr(e.message || String(e));
        btn.disabled = false; // 失败可重试
      }
    });
  </script>
</body>
</html>
